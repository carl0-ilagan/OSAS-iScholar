  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      // Users collection - users can read/write their own document
      match /users/{userId} {
        // Allow read if user is authenticated and reading their own document, or if admin
        allow read: if request.auth != null && (
          request.auth.uid == userId ||
          request.auth.token.email == "contact.ischolar@gmail.com"
        );
        
        // Allow write (create/update) if user is authenticated and writing their own document, or if admin
        allow write: if request.auth != null && (
          request.auth.uid == userId ||
          request.auth.token.email == "contact.ischolar@gmail.com"
        );
      }
      
      // Settings collection - branding settings
      match /settings/{settingId} {
        // Allow read for all users (including unauthenticated for landing page)
        allow read: if true;
        
        // Allow write only for admin (contact.ischolar@gmail.com)
        allow write: if request.auth != null && request.auth.token.email == "contact.ischolar@gmail.com";
      }
      
      // Verifications collection - student verification requests
      match /verifications/{verificationId} {
        // Allow read if user is authenticated and reading their own verification
        allow read: if request.auth != null && (
          request.auth.uid == resource.data.userId ||
          request.auth.token.email == "contact.ischolar@gmail.com"
        );
        
        // Allow create if user is authenticated and creating their own verification
        allow create: if request.auth != null && 
                      request.auth.uid == request.resource.data.userId;
        
        // Allow update only for admin (to change status)
        allow update: if request.auth != null && 
                      request.auth.token.email == "contact.ischolar@gmail.com";
        
        // Allow delete only for admin
        allow delete: if request.auth != null && 
                      request.auth.token.email == "contact.ischolar@gmail.com";
      }

      // Applications collection - scholarship applications
      match /applications/{applicationId} {
        // Allow read if user is authenticated and reading their own application, or if admin
        allow read: if request.auth != null && (
          request.auth.uid == resource.data.userId ||
          request.auth.token.email == "contact.ischolar@gmail.com"
        );
        
        // Allow create if user is authenticated and creating their own application
        allow create: if request.auth != null && 
                      request.auth.uid == request.resource.data.userId &&
                      request.resource.data.userId == request.auth.uid;
        
        // Allow update only for admin (to change status)
        allow update: if request.auth != null && 
                      request.auth.token.email == "contact.ischolar@gmail.com";
        
        // Allow delete only for admin
        allow delete: if request.auth != null && 
                      request.auth.token.email == "contact.ischolar@gmail.com";
      }

      // Scholarships collection - scholarship programs
      match /scholarships/{scholarshipId} {
        // Allow read for all authenticated users
        allow read: if request.auth != null;
        
        // Allow write only for admin
        allow write: if request.auth != null && 
                     request.auth.token.email == "contact.ischolar@gmail.com";
          
          // Allow students to update slots field only (for application slot decrement)
          allow update: if request.auth != null &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['slots']) &&
                      request.resource.data.slots is int &&
                      request.resource.data.slots >= 0 &&
                      request.resource.data.slots < resource.data.slots;
      }

      // Announcements collection
      match /announcements/{announcementId} {
        // Allow read for all authenticated users
        allow read: if request.auth != null;
        
        // Allow write only for admin
        allow write: if request.auth != null && 
                     request.auth.token.email == "contact.ischolar@gmail.com";
      }

      // Feedback collection
      match /feedback/{feedbackId} {
        // Allow read if user is reading their own feedback, or if admin
        allow read: if request.auth != null && (
          resource.data.userId == request.auth.uid ||
          request.auth.token.email == "contact.ischolar@gmail.com"
        );
        
        // Allow create for authenticated users
        allow create: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid;
      }

      // Testimonials collection
      match /testimonials/{testimonialId} {
        // Allow read for all (including unauthenticated for landing page)
        allow read: if true;
        
        // Allow create for authenticated users
        allow create: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid;
        
        // Allow write (update/delete) only for admin
        allow write: if request.auth != null && 
                     request.auth.token.email == "contact.ischolar@gmail.com";
      }

      // Document Requirements collection - requirements set by admin
      match /documentRequirements/{requirementId} {
        // Allow read for all authenticated users (students can see requirements)
        allow read: if request.auth != null;
        
        // Allow write only for admin
        allow write: if request.auth != null && 
                     request.auth.token.email == "contact.ischolar@gmail.com";
          
          // Sample chunks subcollection for large PDF files
          match /sampleChunks/{chunkId} {
            // Allow read for all authenticated users (students need to download PDF samples)
            allow read: if request.auth != null;
            
            // Allow write only for admin
            allow write: if request.auth != null && 
                        request.auth.token.email == "contact.ischolar@gmail.com";
          }
      }

      // Student Documents collection - documents uploaded by students
      match /studentDocuments/{documentId} {
        // Allow read if user is reading their own document, or if admin
        allow read: if request.auth != null && (
          resource.data.userId == request.auth.uid ||
          request.auth.token.email == "contact.ischolar@gmail.com"
        );
        
        // Allow create if user is authenticated and creating their own document
        allow create: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid;
        
        // Allow update if user is updating their own document, or if admin
        allow update: if request.auth != null && (
          resource.data.userId == request.auth.uid ||
          request.auth.token.email == "contact.ischolar@gmail.com"
        );
        
        // Allow delete if user is deleting their own document, or if admin
        allow delete: if request.auth != null && (
          resource.data.userId == request.auth.uid ||
          request.auth.token.email == "contact.ischolar@gmail.com"
        );
        
        // Chunks subcollection for large files
        match /chunks/{chunkId} {
          // Allow read if user owns the parent document, or if admin
          allow read: if request.auth != null && (
            get(/databases/$(database)/documents/studentDocuments/$(documentId)).data.userId == request.auth.uid ||
            request.auth.token.email == "contact.ischolar@gmail.com"
          );
          
          // Allow write if user owns the parent document, or if admin
          allow write: if request.auth != null && (
            get(/databases/$(database)/documents/studentDocuments/$(documentId)).data.userId == request.auth.uid ||
            request.auth.token.email == "contact.ischolar@gmail.com"
          );
        }
      }

      // Student Profile Forms collection - profile forms submitted by students
      match /studentProfileForms/{formId} {
        // Allow read if user is reading their own form, or if admin
        allow read: if request.auth != null && (
          resource.data.userId == request.auth.uid ||
          request.auth.token.email == "contact.ischolar@gmail.com"
        );
        
        // Allow create if user is authenticated and creating their own form
        allow create: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid;
        
        // Allow update if user is updating their own form, or if admin
        allow update: if request.auth != null && (
          resource.data.userId == request.auth.uid ||
          request.auth.token.email == "contact.ischolar@gmail.com"
        );
        
        // Allow delete only for admin
        allow delete: if request.auth != null && 
                      request.auth.token.email == "contact.ischolar@gmail.com";
      }

      // Application Forms collection - application forms submitted by students
      match /applicationForms/{formId} {
        // Allow read if user is reading their own form, or if admin
        allow read: if request.auth != null && (
          resource.data.userId == request.auth.uid ||
          request.auth.token.email == "contact.ischolar@gmail.com"
        );
        
        // Allow create if user is authenticated and creating their own form
        allow create: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid;
        
        // Allow update if user is updating their own form, or if admin
        allow update: if request.auth != null && (
          resource.data.userId == request.auth.uid ||
          request.auth.token.email == "contact.ischolar@gmail.com"
        );
        
        // Allow delete only for admin
        allow delete: if request.auth != null && 
                      request.auth.token.email == "contact.ischolar@gmail.com";
      }
    }
  }

